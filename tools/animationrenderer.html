<!DOCTYPE html>
<html lang="en" style="background-color:rgb(17, 5, 29);">
<head>
    <title>Animation Renderer - URL Input & Custom Loop</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta charset="UTF-8" />
    <style>
        body {
            background-color: rgb(17, 5, 29);
            color: white;
            font-family: monospace;
            user-select: none;
            margin: 2rem;
        }
        label {
            display: block;
            margin-top: 1rem;
            margin-bottom: 0.25rem;
        }
        input[type=text], input[type=number] {
            width: 100%;
            padding: 0.3rem;
            font-family: monospace;
            font-size: 1rem;
        }
        button {
            margin-top: 1rem;
            padding: 0.5rem 1rem;
            font-family: monospace;
            font-size: 1rem;
            cursor: pointer;
        }
        #imgCanvas {
            margin-top: 1rem;
            border: 1px solid #fff;
            image-rendering: pixelated;
        }
        #frameInfo {
            margin-top: 0.5rem;
            font-size: 1.1rem;
            text-align: center;
        }
        .controls button {
            margin: 0 0.25rem;
        }
    </style>
</head>
<body>
    <h1>Incredibox Animation Renderer (URL Import & Custom Loop)</h1>

    <label for="spriteUrl">Sprite Sheet URL (PNG):</label>
    <input type="text" id="spriteUrl" placeholder="https://example.com/spritesheet.png" />

    <label for="jsonUrl">Animation JSON URL:</label>
    <input type="text" id="jsonUrl" placeholder="https://example.com/animation.json" />

    <label for="loopTime">Loop Time (seconds):</label>
    <input type="number" id="loopTime" min="0.1" step="0.1" value="3" />

    <button id="loadBtn">Load Animation</button>

    <canvas id="imgCanvas" width="164" height="225"></canvas>
    <div id="frameInfo">Frame: 0 / 0</div>

    <div class="controls" style="text-align:center; margin-top:1rem;">
        <button id="prevFrame">&lt; Prev Frame</button>
        <button id="playPause">Play</button>
        <button id="nextFrame">Next Frame &gt;</button>
    </div>

<script>
(() => {
    const canvas = document.getElementById('imgCanvas');
    const ctx = canvas.getContext('2d');

    let spriteImage = new Image();
    let animationData = null;
    let frameIndex = 0;
    let playing = false;
    let loopTime = 3.0; // seconds
    let frameCount = 0;
    let frameTimer = 0;
    let lastTimestamp = 0;

    // Constants (you can tweak these if your spritesheet uses different sizes)
    let sheet_sprite_width = 164;
    let sheet_sprite_height = 380;
    let head_height = 225;

    // Array of frames (each frame is [column, row, x, y])
    let framesArray = [];

    // Canvas size update
    function updateCanvasSize() {
        canvas.width = sheet_sprite_width;
        canvas.height = sheet_sprite_height;
    }

    // Draw current frame on canvas
    function drawFrame(index) {
        if (!spriteImage.complete || !animationData) return;
        if (!framesArray[index]) return;

        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = '#000000';
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        // Extract frame info
        const [column, row, xOffset, yOffset] = framesArray[index];

        // Source position on sprite sheet
        const sx = column * sheet_sprite_width;
        const sy = row * sheet_sprite_height;

        // Draw from sprite sheet, then offset on canvas by xOffset,yOffset
        ctx.drawImage(
            spriteImage,
            sx, sy, sheet_sprite_width, sheet_sprite_height,
            xOffset, yOffset, sheet_sprite_width, head_height
        );

        document.getElementById('frameInfo').textContent = `Frame: ${index + 1} / ${frameCount}`;
    }

    // Animation loop using requestAnimationFrame
    function animationLoop(timestamp) {
        if (!lastTimestamp) lastTimestamp = timestamp;
        const delta = (timestamp - lastTimestamp) / 1000; // seconds elapsed
        lastTimestamp = timestamp;

        if (playing && animationData) {
            frameTimer += delta;
            // Calculate frame duration based on loopTime and frameCount
            const frameDuration = loopTime / frameCount;
            if (frameTimer >= frameDuration) {
                frameTimer -= frameDuration;
                frameIndex = (frameIndex + 1) % frameCount;
                drawFrame(frameIndex);
            }
        }
        requestAnimationFrame(animationLoop);
    }

    // Load sprite sheet image by URL
    function loadSprite(url) {
        return new Promise((resolve, reject) => {
            spriteImage = new Image();
            spriteImage.crossOrigin = "anonymous"; // Allow cross origin if CORS enabled
            spriteImage.onload = () => resolve();
            spriteImage.onerror = () => reject(new Error('Failed to load sprite sheet image.'));
            spriteImage.src = url;
        });
    }

    // Load JSON animation data by URL
    async function loadJSON(url) {
        const response = await fetch(url);
        if (!response.ok) throw new Error(`Failed to load JSON data: ${response.statusText}`);
        return response.json();
    }

    // Initialize animation data from JSON
    function initAnimationData(data) {
        animationData = data;

        if (!animationData.arrayFrame || !animationData.totalFrame || !animationData.width || !animationData.height || !animationData.headHeight) {
            throw new Error('JSON missing required properties: arrayFrame, totalFrame, width, height, headHeight');
        }

        framesArray = animationData.arrayFrame;
        frameCount = animationData.totalFrame;
        sheet_sprite_width = animationData.width;
        sheet_sprite_height = animationData.height;
        head_height = animationData.headHeight;

        updateCanvasSize();
        frameIndex = 0;
        drawFrame(frameIndex);
    }

    // Controls
    document.getElementById('loadBtn').addEventListener('click', async () => {
        const spriteUrl = document.getElementById('spriteUrl').value.trim();
        const jsonUrl = document.getElementById('jsonUrl').value.trim();
        loopTime = parseFloat(document.getElementById('loopTime').value);

        if (!spriteUrl || !jsonUrl) {
            alert('Please enter both Sprite Sheet URL and JSON URL.');
            return;
        }
        if (isNaN(loopTime) || loopTime <= 0) {
            alert('Please enter a valid positive number for Loop Time.');
            return;
        }

        try {
            playing = false;
            frameTimer = 0;
            lastTimestamp = 0;

            await loadSprite(spriteUrl);
            const jsonData = await loadJSON(jsonUrl);
            initAnimationData(jsonData);

            document.getElementById('playPause').textContent = 'Play';
        } catch (err) {
            alert(err.message);
        }
    });

    document.getElementById('playPause').addEventListener('click', () => {
        if (!animationData) return;

        playing = !playing;
        document.getElementById('playPause').textContent = playing ? 'Pause' : 'Play';
    });

    document.getElementById('prevFrame').addEventListener('click', () => {
        if (!animationData) return;
        playing = false;
        document.getElementById('playPause').textContent = 'Play';
        frameIndex = (frameIndex - 1 + frameCount) % frameCount;
        drawFrame(frameIndex);
    });

    document.getElementById('nextFrame').addEventListener('click', () => {
        if (!animationData) return;
        playing = false;
        document.getElementById('playPause').textContent = 'Play';
        frameIndex = (frameIndex + 1) % frameCount;
        drawFrame(frameIndex);
    });

    // Start animation loop
    requestAnimationFrame(animationLoop);

})();
</script>
</body>
</html>
